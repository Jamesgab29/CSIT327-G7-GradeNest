{% extends 'accounts/base.html' %}
{% load static %}
{% block title %}Profile - GradeNest{% endblock %}
{% block extra_css %}
  <link rel="stylesheet" href="{% static 'accounts/css/profile.css' %}?v={{ CACHE_VERSION }}" />
{% endblock %}

{% block content %}
  <div class="content-wrapper">

    <!-- Breadcrumb Navigation -->
    <div class="breadcrumb-nav" id="breadcrumbNav">
      <span class="breadcrumb-item" data-level="settings">Settings</span>
      <span class="breadcrumb-separator">â€º</span>
      <span class="breadcrumb-item active" data-level="profile">Profile</span>
    </div>

    <!-- Profile View -->
    <div id="profileView" class="view-container active">
      
      <!-- Profile Header -->
      <div class="profile-header">
        <div class="profile-header-content">
          <div class="profile-avatar-large">
            <img src="{% static 'accounts/img/profile-icon.png' %}" alt="Profile" />
            <div class="avatar-badge">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                <path d="M10 0C4.477 0 0 4.477 0 10s4.477 10 10 10 10-4.477 10-10S15.523 0 10 0zm4.707 7.707l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 111.414-1.414L9 10.586l4.293-4.293a1 1 0 011.414 1.414z" fill="#38CA79"/>
              </svg>
            </div>
          </div>
          <div class="profile-header-info">
            <h1 class="profile-title">{{ user.get_full_name|default:"Student Profile" }}</h1>
            <p class="profile-subtitle">Manage your personal information and academic details</p>
          </div>
        </div>
      </div>

      <!-- Profile Content Grid -->
      <div class="profile-content-grid">
        
        <!-- Personal Information Card -->
        <div class="profile-card">
          <div class="card-header">
            <div class="card-header-left">
              <div class="card-icon personal">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                  <path d="M10 10a4 4 0 100-8 4 4 0 000 8zM3 18a7 7 0 0114 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
              </div>
              <h2 class="card-title">Personal Information</h2>
            </div>
          </div>
          
          <div class="card-body">
            <form id="personalInfoForm" novalidate>
              <!-- First Name -->
              <div class="form-group">
                <label class="form-label" for="firstName">
                  First Name
                  <span class="required-mark">*</span>
                </label>
                <input 
                  type="text" 
                  id="firstName" 
                  name="firstName" 
                  class="form-input"
                  value="{{ user.first_name|default:user.full_name|default:'' }}"
                  required
                />
                <span class="form-error" id="firstNameError"></span>
              </div>

              <!-- Last Name -->
              <div class="form-group">
                <label class="form-label" for="lastName">
                  Last Name
                  <span class="required-mark">*</span>
                </label>
                <input 
                  type="text" 
                  id="lastName" 
                  name="lastName" 
                  class="form-input"
                  value="{{ user.last_name|default:'' }}"
                  required
                />
                <span class="form-error" id="lastNameError"></span>
              </div>

              <!-- Email -->
              <div class="form-group">
                <label class="form-label" for="email">
                  Email Address
                  <span class="required-mark">*</span>
                </label>
                <input 
                  type="email" 
                  id="email" 
                  name="email" 
                  class="form-input"
                  value="{{ user.email }}"
                  required
                />
                <span class="form-error" id="emailError"></span>
              </div>

              <!-- Save Button -->
              <div class="form-actions">
                <button type="submit" class="btn-save" id="savePersonalInfo">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                    <path d="M13.333 4L6 11.333 2.667 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                  Save Changes
                </button>
              </div>
            </form>
          </div>
        </div>
        <!-- Account Security Card -->
         <div class="profile-card">
          <div class="card-header">
            <div class="card-header-left">
          <div class="card-icon security">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
              <path d="M10 2l6 2v5c0 3.866-2.239 7-6 9-3.761-2-6-5.134-6-9V4l6-2z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
            </svg>
          </div>
          <h2 class="card-title">Account Security</h2>
        </div>
      </div>
      
      <div class="card-body">
        <form id="securityForm" novalidate>

          <!-- Current Password -->
          <div class="form-group">
            <label class="form-label" for="currentPassword">
              Current Password
              <span class="required-mark">*</span>
            </label>
            <div class="password-input-wrapper">
              <input 
                type="password" 
                id="currentPassword" 
                name="currentPassword" 
                class="form-input"
                placeholder="Enter current password"
              />
              <button type="button" class="toggle-password" data-target="currentPassword">
                <svg class="eye-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
                  <path d="M10 4C5 4 1.73 7.11 1 10c.73 2.89 4 6 9 6s8.27-3.11 9-6c-.73-2.89-4-6-9-6z" stroke="currentColor" stroke-width="2"/>
                  <circle cx="10" cy="10" r="3" stroke="currentColor" stroke-width="2"/>
                </svg>
              </button>
            </div>
            <span class="form-error" id="currentPasswordError"></span>
          </div>

         <!-- New Password -->
          <div class="form-group">
            <label class="form-label" for="newPassword">
              New Password
              <span class="required-mark">*</span>
            </label>
            <div class="password-input-wrapper">
              <input 
                type="password" 
                id="newPassword" 
                name="newPassword" 
                class="form-input"
                placeholder="Enter new password"
              />
              <button type="button" class="toggle-password" data-target="newPassword">
                <svg class="eye-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
                  <path d="M10 4C5 4 1.73 7.11 1 10c.73 2.89 4 6 9 6s8.27-3.11 9-6c-.73-2.89-4-6-9-6z" stroke="currentColor" stroke-width="2"/>
                  <circle cx="10" cy="10" r="3" stroke="currentColor" stroke-width="2"/>
                </svg>
              </button>
            </div>
            <span class="form-error" id="newPasswordError"></span>
          </div>

          <!-- Confirm Password -->
          <div class="form-group">
           <label class="form-label" for="confirmPassword">
              Confirm New Password
              <span class="required-mark">*</span>
            </label>
            <div class="password-input-wrapper">
              <input 
                type="password" 
                id="confirmPassword" 
                name="confirmPassword" 
                class="form-input"
                placeholder="Confirm new password"
              />
              <button type="button" class="toggle-password" data-target="confirmPassword">
                <svg class="eye-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
                  <path d="M10 4C5 4 1.73 7.11 1 10c.73 2.89 4 6 9 6s8.27-3.11 9-6c-.73-2.89-4-6-9-6z" stroke="currentColor" stroke-width="2"/>
                  <circle cx="10" cy="10" r="3" stroke="currentColor" stroke-width="2"/>
                </svg>
              </button>
            </div>
            <span class="form-error" id="confirmPasswordError"></span>
          </div>

      <!-- Password Requirements -->
         <div class="password-requirements">
            <p class="requirements-title">Password must contain:</p>
            <ul class="requirements-list">
              <li class="requirement-item" id="reqLength">
               <svg class="req-icon" width="16" height="16" viewBox="0 0 16 16" fill="none">
                  <circle cx="8" cy="8" r="7" stroke="currentColor" stroke-width="2"/>
                </svg>
                At least 8 characters
              </li>
              <li class="requirement-item" id="reqUppercase">
                <svg class="req-icon" width="16" height="16" viewBox="0 0 16 16" fill="none">
                  <circle cx="8" cy="8" r="7" stroke="currentColor" stroke-width="2"/>
                </svg>
                One uppercase letter
              </li>
              <li class="requirement-item" id="reqLowercase">
                <svg class="req-icon" width="16" height="16" viewBox="0 0 16 16" fill="none">
                  <circle cx="8" cy="8" r="7" stroke="currentColor" stroke-width="2"/>
                </svg>
                One lowercase letter
              </li>
              <li class="requirement-item" id="reqNumber">
                <svg class="req-icon" width="16" height="16" viewBox="0 0 16 16" fill="none">
                  <circle cx="8" cy="8" r="7" stroke="currentColor" stroke-width="2"/>
                </svg>
                One number
              </li>
            </ul>
          </div>

          <!-- Save Button -->
          <div class="form-actions">
            <button type="submit" class="btn-save" id="updatePassword">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                <path d="M13.333 4L6 11.333 2.667 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              Update Password
            </button>
          </div>
        </form>
      </div>
    </div>


        <!-- Academic Information Card -->
        <div class="profile-card full-width">
          <div class="card-header">
            <div class="card-header-left">
              <div class="card-icon academic">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                  <path d="M10 2L2 6l8 4 8-4-8-4z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                <path d="M2 10l8 4 8-4M6 8.5v5a4 4 0 008 0v-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <h2 class="card-title">Academic Information</h2>
          </div>
          <span class="info-badge">Current School Year: {{ profile.school_year|default:"2024-2025" }}</span>
          <!-- <button type="button" class="btn-edit" id="editAcademicInfoBtn">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path d="M12.13 2.87a2 2 0 112.83 2.83l-7.5 7.5-3.46.63.63-3.46 7.5-7.5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Edit
        </button> -->
      </div>
        <div class="card-body">
          <form id="academicInfoForm" novalidate>
            <div id="academicInfoDisplay">
              <div class="form-group">
                <label class="form-label">School Level</label>
                <div id="displayGradeLevel">{{ profile.grade_level|default:"Grade 7" }}</div>
              </div>
                <div class="form-group" id="displayStrandGroup" {% if not isSHS %}style="display:none;"{% endif %}>
              <label class="form-label">Strand</label>
              <div id="displayStrand">{{ profile.strand|default:"â€”" }}</div>
            </div>
            </div>
        <div id="academicInfoEdit" style="display:none;">

              <!-- School Level -->
              <div class="form-group">
          <label class="form-label" for="gradeLevel">
            School Level <span class="required-mark">*</span>
          </label>
          <select id="gradeLevel" name="gradeLevel" class="form-select" required>
            <option value="">Select Level</option>
            <optgroup label="Junior High School">
              <option value="Grade 7" {% if profile.grade_level == "Grade 7" %}selected{% endif %}>Grade 7</option>
              <option value="Grade 8" {% if profile.grade_level == "Grade 8" %}selected{% endif %}>Grade 8</option>
              <option value="Grade 9" {% if profile.grade_level == "Grade 9" %}selected{% endif %}>Grade 9</option>
              <option value="Grade 10" {% if profile.grade_level == "Grade 10" %}selected{% endif %}>Grade 10</option>
            </optgroup>
            <optgroup label="Senior High School">
              <option value="Grade 11" {% if profile.grade_level == "Grade 11" %}selected{% endif %}>Grade 11</option>
              <option value="Grade 12" {% if profile.grade_level == "Grade 12" %}selected{% endif %}>Grade 12</option>
            </optgroup>
          </select>
          <span class="form-error" id="gradeLevelError"></span>
        </div>

              <!-- Strand (SHS Only) -->
              <div class="form-group" id="strandGroup" style="display: none;">
          <label class="form-label" for="strand">
            Strand <span class="required-mark">*</span>
          </label>
          <select id="strand" name="strand" class="form-select">
            <option value="">Select Strand</option>
            <optgroup label="Academic Track">
              <option value="STEM" {% if profile.strand == "STEM" %}selected{% endif %}>STEM</option>
              <option value="ABM" {% if profile.strand == "ABM" %}selected{% endif %}>ABM</option>
              <option value="HUMSS" {% if profile.strand == "HUMSS" %}selected{% endif %}>HUMSS</option>
              <option value="GAS" {% if profile.strand == "GAS" %}selected{% endif %}>GAS</option>
            </optgroup>
            <optgroup label="Technical-Vocational-Livelihood Track">
              <option value="TVL-ICT" {% if profile.strand == "TVL-ICT" %}selected{% endif %}>TVL-ICT</option>
              <option value="TVL-HE" {% if profile.strand == "TVL-HE" %}selected{% endif %}>TVL-HE</option>
              <option value="TVL-IA" {% if profile.strand == "TVL-IA" %}selected{% endif %}>TVL-IA</option>
            </optgroup>
            <optgroup label="Sports & Arts Track">
              <option value="Sports" {% if profile.strand == "Sports" %}selected{% endif %}>Sports</option>
              <option value="Arts-Design" {% if profile.strand == "Arts-Design" %}selected{% endif %}>Arts-Design</option>
            </optgroup>
          </select>
          <span class="form-error" id="strandError"></span>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn-save" id="saveAcademicInfo">Save Changes</button>
          <button type="button" class="btn-cancel" id="cancelAcademicEdit">Cancel</button>
        </div>
      </div>
    </form>
  </div>
</div>

      </div>
    </div>

  </div>
{% endblock %}

<!-- Success Toast -->
<div class="toast success" id="successToast">
  <div class="toast-icon">
    <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
      <path d="M16.667 5L7.5 14.167 3.333 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </div>
  <div class="toast-content">
    <p class="toast-title">Success!</p>
    <p class="toast-message" id="successMessage"></p>
  </div>
</div>

<!-- Error Toast -->
<div class="toast error" id="errorToast">
  <div class="toast-icon">
    <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
      <path d="M10 6v4M10 14h.01M19 10a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
  </div>
  <div class="toast-content">
    <p class="toast-title">Error</p>
    <p class="toast-message" id="errorMessage"></p>
  </div>
</div>

<!-- Progression Confirmation Modal -->
<div class="modal-overlay" id="progressionModal">
  <div class="modal-container">
    <div class="modal-header">
      <h3 class="modal-title">ðŸŽ“ Level Progression Detected</h3>
    </div>
    <div class="modal-body">
      <p class="modal-message">You've completed <strong id="completedYear"></strong>!</p>
      <p class="modal-message">Your level will be automatically updated to <strong id="nextLevel"></strong> for the next school year.</p>
      <p class="modal-warning">Do you want to proceed with this change?</p>
    </div>
    <div class="modal-footer">
      <button class="btn-modal-cancel" id="btnCancelProgression">Not Yet</button>
      <button class="btn-modal-confirm" id="btnConfirmProgression">Confirm</button>
    </div>
  </div>
</div>

{% block extra_js %}
  <script id="user-profile-data" type="application/json">
{
  "gradeLevel": "{{ profile.grade_level|default:'Grade 7' }}",
  "strand": "{{ profile.strand|default:'' }}",
  "schoolYear": "{{ profile.school_year|default:'Not set' }}",
  "isJHS": {{ isJHS|yesno:"true,false" }},
  "isSHS": {{ isSHS|yesno:"true,false" }}
}
  </script>
  <script>
    window.userProfile = JSON.parse(document.getElementById('user-profile-data').textContent);
  </script>
  <script src="{% static 'accounts/js/profile.js' %}?v={{ CACHE_VERSION }}" defer></script>
{% endblock %}